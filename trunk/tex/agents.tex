\subsection{Übersicht Nagios-Agenten}
In diesem Unterkapitel werden die populärsten Agenten für Unix und Windows Betriebssysteme aufgelistet und nach den Punkten Sicherheit, subjektiver Aufwand für die Konfiguration und Art der Abfragemethode (aktiv oder passiv) verglichen.

\subsubsection{Unix-Agenten}
Für die auf Unix basierenden Betriebssysteme werden fünf verschiedene Möglichkeiten angeboten, die in Abbildung \ref{nagios-kern} als verschiedene Überwachungsmöglichkeiten von Nagios aufgelistet wurden.

\input{tex/tab-unixagents.tex}

Dabei werden drei Agenten genannt, die eine aktive Ausführung der Nagios-Plugins benutzten.
Alle drei Agenten unterscheiden sich jedoch in den Punkten Sicherheit und Aufwand.
Der auf \gls{SSH} basierende Agent besitzt einen relativ geringen Aufwand für die Installation, da für den Aufbau der Kommunikation zwischen Nagios-Server und Client nur der öffentliche Schlüssel des Servers auf dem Client eingetragen werden muss.
Dadurch kann der Nagios-Server sich ohne Passwortabfrage an dem zu überwachendem Host anmelden und die sich darauf befindlichen Nagios-Plugins ausführen.
Da auf den meisten Unix-Servern bereits ein \gls{SSH}-Server läuft und deshalb kein weiterer Port geöffnet oder eine weitere Software installiert werden muss, ist diese Methode den anderen meist vorzuziehen.

Bei der \gls{NRPE}-Methode wird eine weitere Softwarekomponente auf dem Client installiert, die einen separaten Port für die Kommunikation mit dem Nagios-Server öffnet.
Wie bei dem Aufruf per \gls{SSH} müssen sich hier die Nagios-Plugins bereits auf dem Rechner befinden.
Dabei gilt als Unterschied dieser zwei ähnlichen Methoden zu beachten, dass für die Ausführung der Checks per \gls{SSH} ein extra Benutzerkonto auf dem Client erstellt werden muss und somit beliebige Systembefehle ausgeführt werden können, während die Ausführung von Kommandos bei \gls{NRPE} nur auf vorkonfigurierte Befehle beschränkt ist, wie in Kapitel \ref{sshnrpe} aufgeführt.
\label{unixagents}
Da \gls{SNMP} plattformunabhängig funktioniert ist es möglich diese Variante bei Unix- sowie bei Windowsservern einzusetzen.
Die verwendete \gls{SNMP}-Version bestimmt welche Sicherheitsmerkmale zur Verfügung stehen.
Zwar gibt es bereits seit Version 1 die Möglichkeit den Zugriff per Passwort in drei Gruppen aufzuteilen: kein Zugriff, Leserecht und Lese- mit Schreibrecht\footnote{Quelle: \cite{Barth08} S. 237}, jedoch wird dieses Passwort im Klartext übertragen, so dass es leicht auslesbar ist.
Auch die \gls{SNMP}-Version 2 inklusive der erweiterten Version 2c verwendet die gleiche unsichere Authentifizierung.
Erst ab Version 3 wird das Passwort verschlüsselt übertragen.
Während Barth behauptet, dass man bei \gls{SNMP} generell kein Passwort verwenden soll\footnote{Quelle: \cite{Barth08} S. 238}, da es leicht per Netzwerkmitschnittprogramme, wie WireShark, ausgelesen werden kann, wird in \cite{Jose07} S. 121 klargestellt, dass die Version 3 eine verschlüsselte Authentifizierung durch den MD5- oder SHA-Algorithmus ermöglicht.

Die passive Variante über \gls{SNMP} bei der der Client die Ergebnisse der Checks an den Nagios-Server sendet, auch \gls{SNMP}-Traps genannt, funktioniert nach dem gleichen Prinzip.
Da das Auslesen der \gls{MIB} per \gls{SNMP} im Gegensatz zu den anderen Varianten deutlich komplexer ist, wird der Aufwand als hoch eingestuft.

Ein weiterer Vertreter, der passive Checks ermöglicht, ist der \gls{NSCA}-Agent.
Wie die anderen Unix-Agenten bietet es die Möglichkeit den Datenaustausch zwischen Nagios-Server und Client zu verschlüsseln.
Alle Unix-Agenten erlauben es den Zugriff auf die Nagios-Plugins auf bestimmte \gls{IP}-Adressen zu beschränken.
Die Liste mit diesen \gls{IP}-Adressen nennt man auch \textit{Accesslist}.

\subsubsection{Windows-Agenten}
Da die zu überwachende Oracle UCM Anwendung auf einem Windows-Server betrieben wird und die bereits vorgestellten Agenten mit Ausnahme der \gls{SNMP}-Varianten nur unter Unix einsetzbar sind, müssen zusätzlich die explizit für Windows entwickelten Nagios-Agenten untersucht werden.
Dabei wird die Auswahl der Kandidaten auf vier Bewerber beschränkt, siehe Tabelle \ref{tab:winagents}.
\input{tex/tab-winagents.tex}
\newpage
Der NSClient-Dienst liefert die Möglichkeit lokale Windows-Ressourcen über das Netzwerk mit eigenem Port (Standport 1248) abzufragen.
Das Plugin \textit{check\_nt} wurde explizit für diesen NSClient-Dienst entwickelt und steht durch die Nagios-Plugins standardmäßig zur Verfügung.
Dadurch können die grundlegende Informationen für die Systemüberwachung aus Kapitel \ref{syschecks}, wie Zustände von Prozesse, Services, CPU-Auslastung, Festplattenplatz, usw. abgefragt werden.
Der Zugriff auf den NSClient-Dienst per \textit{check\_nt} wird in Abbildung \ref{fig:cknt} gezeigt.
\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.8\textwidth]{bilder/monitoring-windows.png}}
		\caption[Abfrage von Windows-Ressourcen durch \textit{check\_nt}]{Abfrage von Windows-Ressourcen durch \textit{check\_nt}\protect\footnote}
		\label{fig:cknt}
\end{figure}
\footnotetext{Quelle: \url{http://nagios.sourceforge.net/docs/3\_0/images/monitoring-windows.png}}

Diese Abfrage kann durch die Ausführung auf der Kommandozeile getestet werden:

\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.75\textwidth]{bilder/check_nt-stdp.png}}
		\caption{Zugriff auf den NSClient-Dienst durch check\_nt}
		\label{fig:ckntsh}
\end{figure}

Der erste und zugleich älteste Agent NSClient wird nicht mehr aktiv entwickelt und ist als aktuellste Version 2.0.1 aus dem Jahre 2003 bereits recht alt.
Daher wird auch keine Verschlüsselung der ein- und ausgehenden Daten unterstützt.
Auch bietet NSClient keine Möglichkeit aktiv vom Nagios-Server aus Nagios-Plugins oder weite Programme auszuführen, die sich auf dem zu überwachendem Host befinden.

Um dies auch für Windows-Server zu ermöglichen gibt es eine auf Windows portierte \gls{NRPE}-Variante, die sich NRPE\_NT nennt.
Hier lassen sich die Plugins direkt über den Nagios-Server aufrufen und die ausgetauschten Informationen werden verschlüsselt über das Netzwerk übertragen.

Beide bisher genannte Windows-Agenten bieten keine Möglichkeit eine \textit{Accesslist} anzulegen, erst das Programm NC\_net bietet diese Möglichkeit inklusive dem Sicherheitsmerkmal Verschlüsselung an.
Außerdem können durch den eingebauten \gls{NRPE}-Dienst aktiv Nagios-Plugins auf dem Client aufgerufen werden.
Als Besonderheit lassen sich durch NC\_net sowohl aktiv als auch passiv Testergebnisse an den Nagios-Server übertragen. 

Der Nagios-Agent NSClient++ besitzt diesselben Merkmale wie NC\_net, jedoch kann der Nagios-Server noch über ein Passwort zusätzlich verifiziert werden.

Die Möglichkeit Informationen per \gls{SNMP} und \gls{SNMP}-Traps abzufragen ist auch unter Windows möglich.
Dabei gelten die gleichen Richtlinien, Hinweise und Einschränkungen wie zuvor in Kapitel \ref{unixagents} aufgeführt.

\subsubsection{Auswahl und Konfiguration des Nagios-Agenten}

\paragraph{Auswahl}
Anhand der im vorherigen Kapitel beschriebenen Übersicht der Windows-Agenten und der daraus resultierenden Übersichtstabelle \ref{tab:winagents} wird ein geeigneter Kandidat für die Testumgebung ausgewählt.
Da nur ein Windows-Agent alle drei Sicherheitsmerkmale anbietet und dabei aktive und passive Überwachungsmethoden erlaubt, fällt die Wahl auf das Programm \textbf{NSClient++}.

\paragraph{Installation und Konfiguration}

Der Nagios-Agent NSClient++ kann im Gegensatz zu den meisten anderen Windows-Agenten komfortabel über einen graphischen Benutzerdialog installiert werden.
Während des Installationsvorgangs kann auch festgelegt werden welche Komponenten installiert werden sollen.
Dabei werden diese Komponenten nicht standardmäßig geladen, sondern im nächsten Dialogfenster auswählbar:

\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.55\textwidth]{bilder/nsc2.png}}
		\caption{Konfiguration des NSClient++ während der Installation}
		\label{nscs2}
\end{figure}

Außerdem können direkt während der Installation die \gls{IP}-Adresse bzw. der \gls{FQDN} des Nagios-Servers und das gewünschte Passwort eingetragen werden.

Durch die während des Installationsprozesses geladenen Komponenten für den NSClient- und \gls{NRPE}-Dienst können die Standard-Nagios-Plugins \textit{check\_nt} und \textit{check\_nrpe} mit dem Windows-Server verwendet werden.
Dabei läuft die Kommunikation zwischen dem Nagios- und dem Windows-Server folgendermaßen ab:

\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.7\textwidth]{bilder/nagios-active-nsclient-and-nrpe.png}}
		\caption[Kommunikation zwischen Nagios und NSClient++]{Kommunikation zwischen Nagios und NSClient++\protect\footnote}
		\label{nscs2}
\end{figure}
\footnotetext{\url{http://nsclient.org/nscp/}}
%http://nsclient.org/nscp/raw-attachment/wiki/doc/usage/nagios/nagios-active-nsclient.png

Bei Windows-Server mit vielen Verbindungen und Diensten können Remote Procedure Calls (\gls{RPC}), bei denen dynamisch Ports ab 1025 verwendet werden, bereits den Standardport des NSClient-Dienstes (1248) unter Umständen bereits vor dem Start des Dienstes belegen.\footnote{Quelle: \cite{Barth08} S. 481}
Um dies zu verhindern wurde der Port des NSClient-Dienstes beim NSClient++ bereits vom Entwickler auf einen höheren Port (12489) gewechselt.

Alle bisherigen Einstellungen können in der Konfigurationsdatei \textit{NSC.ini}, die sich in dem Installationsverzeichnis des NSClient++ befindet, verändert werden.
In dieser Datei befinden sich noch mehr Einstellungsmöglichkeiten; im Folgenden werden nur für die Umsetzung relevanten (notwendig essentiell benötigten) Parameter aufgelistet.

\begin{lstlisting}[captionpos=b, caption=NSClient++ Konfigurationsdatei, label=code:nsc, breaklines = true, language=sh]
;# NSCLIENT PORTNUMMER
;#  Die Portnummer des NSClient-Dienstes
port=13596

;# NRPE PORTNUMMER
;#  Die Portnummer des NRPE-Dienstes
port=13597

;# SSL SOCKET
;#  Die Aktivierung von SSL der Kommunikation zwischen Nagios- und Windows-Server 
use_ssl=1

;# NRPE BEFEHLSDEFINITIONEN
;# Definitionen der Befehle, die durch den NRPE-Dienst aufrufbar sind
check_uname=scripts\check_uname.exe
check_reflog=scripts\check_logfiles.exe -f scripts\logfile.cfg
\end{lstlisting}

Damit die vorgenommen Änderung übernommen werden, muss der Dienst des NSClient++ neu gestartet werden. 

%\begin{figure}[ht]
%	\centering
%	   \fbox{\includegraphics[width=0.85\textwidth]{bilder/nsc3.png}}
%		\caption{NSClient++ Windowsdiensteintrag}
%		\label{nscs3}
%\end{figure}

Durch das Ausweichen auf höher gelegene Portnummern können die zuvor genannten Probleme aufgrund der \gls{RPC}s verhindert werden.

Der bereits höher liegende Standardport des NSClient-Dienstes beim NSClient++ wird zusätzlich noch abgeändert, damit die Tatsache, dass sich ein Nagios-Agent auf dem Computer befindet, nicht sofort ersichtlich ist.
Dieser sicherheitstechnische Aspekt wurde bereits in Kapitel \ref{changeport} behandelt.

Damit die \gls{SSL}-Verschlüsselung zwischen den Servern aktiviert wird, muss man es explizit in der Konfigurationsdatei mit der Option \textit{use\_ssl=1} angeben.

Die Definitionen der \gls{NRPE}-Kommandos dienen dafür, dass durch den Nagios-Server per \textit{check\_nrpe} mit dem Befehlsnamen der darauf folgende Befehl ausgeführt wird.

Aufgrund der abgeänderten Portnummer muss man den Port bei dem Aufruf explizit angeben.
Ein Aufruf eines solchen \gls{NRPE}-Kommandos vom Nagios-Server wird in der folgenden Abbildung gezeigt:

\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.85\textwidth]{bilder/nrpe-check.png}}
		\caption{Aufruf eines NRPE-Kommandos}
		\label{nrpecheck}
\end{figure}



Anhand des Befehlsnamens \textit{check\_uname} führt der \gls{NRPE}-Dienst die in der Konfigurationsdatei eingetragene Datei \textit{check\_uname.exe} aus.

Der Aufruf um Informationen durch den NSClient-Dienst abzufragen sieht ähnlich aus:

\begin{figure}[ht]
	\centering
	   \fbox{\includegraphics[width=0.85\textwidth]{bilder/nsclient-check.png}}
		\caption{Aufruf des NSClient-Dienstes}
		\label{ntcheck}
\end{figure}

Die Servicedefinition des vorherigen NSClient-Aufrufs muss wie nachfolgend/folgt in der Nagios-Konfiguration eingetragen:
\begin{lstlisting}[captionpos=b, caption=Servicedefinition des NSClient-Checks, label=nt-servdef, breaklines = true, language=sh]
define service{
        use                     generic-service
        host_name               example.kit.edu
        service_description     Uptime
        check_command           check_nt!-p 13596 -s secret -v UPTIME
        }
\end{lstlisting}

Damit nicht jeder einzelne Serviceeintrag abgeändert werden muss, falls sich der Port oder das Passwort des zu überwachenden Computers ändert, können eigene Befehlsdefinitionen erstellt werden.

\begin{lstlisting}[captionpos=b, caption=Server spezifische Befehlsdefinition, label=cus-nt-servdef, breaklines = true, language=sh]        
define command{
        command_name    check_nt_example
        command_line    /usr/lib/nagios/plugins/check_nt -H $HOSTNAME$ -p 13597 -p secret -v $ARG1$
        }
\end{lstlisting}

Dadurch muss nur diese Befehlsdefinition bei einer Änderung bearbeitet werden.
Die vorherige Servicedefinition in Listing \ref{ntcheck} kann dann in verkürzter Form eingetragen werden:

\begin{lstlisting}[captionpos=b, caption=Verkürzte Servicedefinition des NSClient-Checks, label=nt-servdef, breaklines = true, language=sh]
define service{
        use                     generic-service
        host_name               example.kit.edu
        service_description     Uptime
        check_command           check_nt_example!UPTIME
        }
\end{lstlisting}


